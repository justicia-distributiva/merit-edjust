---
title: "Analysis"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
      number_sections: yes
    code_folding: hide
    number_sections: yes
editor_options:
  chunk_output_type: console
---
# Setup

```{r setup}
knitr::opts_chunk$set(
	echo = FALSE,
	results = "asis",
	message = FALSE,
	warning = FALSE, 
	fig.height = 18, 
	fig.width = 11, 
	cache = TRUE
)
options(scipen=9999) # desactivar notacion cientifica
remove(list = ls()) #limpieza del entorno de trabajo
```

```{css, echo=FALSE}
# /* expandir el espacio del documento*/
body .main-container {
      max-width: 1600px !important;
      width: 1600px !important;
    }
#/* expandir width de la TOC*/
div.tocify {
    width: 22% !important;
    max-width: 331px !important;
    max-height: 102% !important;
}
```

# Descriptive analysis

## Univariate

```{r tab-desc, results="asis", warning=FALSE}
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               ggplot2,
               sjPlot,
               tidyverse,
               ggalluvial,
               survey,
               shadowtext,
               srvyr
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# Css
st_css()
st_options(lang = "en",
           footnote = NA,
           bootstrap.css = F,
           custom.css = here::here("input/css/dfsummary.css"),
           dfSummary.custom.1 = NA
           )  

# Df variables nivel 1
# df<- dfSummary(df_study1_long %>% select(in_simpat:edad),
#                plain.ascii = FALSE,
#                style = "grid",
#                tmp.img.dir = "/tmp",
#                graph.magnif = TRUE,
#                headings = F,  # encabezado
#                varnumbers = F, # num variable
#                labels.col = T, # etiquetas
#                na.col = F,    # missing
#                graph.col = T, # plot
#                valid.col = T, # n valido
#                col.widths = c(700,10,10,10,10)
#                )
# df$Variable <- NULL # delete variable column
# view(df,
#      file = here::here("output/tables/desc01.html")
#      ) # Ver tabla en un archivo HTML
# webshot::webshot(url =here::here("output/tables/desc01.html"),
#         file =here::here("output/tables/desc01.png")) # Remover archivo HTML
# # print(df, method = "render")

# Df variables nivel 1 _________________________________________________________
df_study1 <- df_study_long_t7_comunas %>% dplyr::select(ola, idencuesta,
                                               just_educ, covid_economia, covid_beneficios, des_perc, merit_talent, merit_effort,
                                               educ, ing_pc, ess:sexo)
colSums(is.na(df_study1))

df_study1 <- df_study1[complete.cases(df_study1$covid_economia), ]
df_study1 <- df_study1[complete.cases(df_study1$ing_pc), ]
df_study1 <- df_study1[complete.cases(df_study1$pos_id), ]
df_study1 <- df_study1[complete.cases(df_study1$covid_beneficios), ]
df_study1 <- df_study1[complete.cases(df_study1$ess), ]

sjmisc::frq(df_study1$ola)

ids <- 
  df_study1 %>% 
  select(idencuesta,ola) %>% 
  filter(ola==1) %>% 
  sjmisc::frq(idencuesta,show.na = F) %>% as.data.frame()

# filter data by the idencuesta of t7
df_study1 <- 
  df_study1 %>%
  filter(idencuesta %in% ids$val)

df_study1$ola <- factor(df_study1$ola,
         labels = c("2016","2017","2018","2019", "2022", "2023"))
df_study1$ola <- 
sjlabelled::set_label(x = df_study1$ola,
                      label = "Wave")

df_study1$sexo <- factor(df_study1$sexo,
         labels = c("Male", "Female"))
df_study1$sexo <- 
sjlabelled::set_label(x = df_study1$sexo,
                      label = "Gender")

for (i in c("just_educ", "des_perc", "covid_economia",
            "merit_effort","merit_talent")) {
  df_study1[[i]] <- factor(df_study1[[i]],
                            levels = 1:5,
                            labels = c("Strongly disagree","Disagree",
                                       "Neither disagree nor agree",
                                       "Agree", "Strongly agree"))
}

df_study1$covid_beneficios<- car::recode(df_study1$covid_beneficios, c("1=2; 2=1"))
df_study1$covid_beneficios <- factor(df_study1$covid_beneficios,
                                     levels = 1:2,
                                     labels = c("No", "Yes"))

df_study1$just_educ <- 
sjlabelled::set_label(x = df_study1$just_educ, 
                      label = "Justification of educational inequality")

df_study1$covid_economia <- 
sjlabelled::set_label(x = df_study1$covid_economia, 
                      label = "In the context of the coronavirus pandemic, it is more important to give priority to economic activity than to the health of the population")

df_study1$covid_beneficios <- 
sjlabelled::set_label(x = df_study1$covid_beneficios, 
                      label = "Obtained state benefits during the covid-19 pandemic")
#
df_study1$des_perc <- 
sjlabelled::set_label(x = df_study1$des_perc, 
                      label = "Income differences are too large") 

#
df_study1$merit_effort <- 
sjlabelled::set_label(x = df_study1$merit_effort, 
                      label = "People are rewarded for their efforts")

#
df_study1$merit_talent <- 
sjlabelled::set_label(x = df_study1$merit_talent, 
                      label = "People are rewarded for their intelligence and skills")

#
df_study1$educ <- 
sjlabelled::set_label(x = df_study1$educ, 
                      label = "Educational level")

#
df_study1$edad <- 
sjlabelled::set_label(x = df_study1$edad, 
                      label = "Age groups")

#
df_study1$pos_id <- 
sjlabelled::set_label(x = df_study1$pos_id, 
                      label = "Political identification")


lab_study1 <- sjlabelled::get_label(df_study1) 
df_study1 <- df_study1 %>% sjlabelled::set_label(lab_study1)

df<- dfSummary(x = dplyr::select(df_study1, ola, covid_economia, covid_beneficios, merit_talent, merit_effort, des_perc, educ, ing_pc, ess, edad, sexo, pos_id),
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "/tmp",
               graph.magnif = TRUE,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = T, # plot
               valid.col = F, # n valido
               col.widths = c(700,10,10,10)
               )
df$Variable <- NULL # delete variable column
summarytools::view(df,
     file = here::here("output/tables/desc02.html")
     ) # Ver tabla en un archivo HTML
webshot::webshot(url =here::here("output/tables/desc02.html"),
        file =here::here("output/tables/desc02.png")) # Remover archivo HTML
# print(df, method = "render")
```

```{r}
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))
df_study1 <- df_study_long_t7_comunas %>% dplyr::select(idencuesta, ola, ponderador_long_total, segmento, estrato,
                                               just_educ, covid_economia, covid_beneficios, merit_talent, merit_effort, des_perc, educ, ing_pc, ess, edad, sexo, pos_id) %>% na.omit()
df_study1 <- df_study1[complete.cases(df_study1$segmento), ]

df_study1$just_educ <- factor(df_study1$just_educ,
         labels = c("Strongly 
disagree", "Disagree", "Neither agree
nor disagree", "Agree", "Strongly 
agree"))

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador_long_total, #ponderador longitudinal
                          nest = TRUE,
                          data = df_study1)


#Paso 1
datos.justeduc <- data.frame((svytable(~just_educ + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#Paso 2
etiquetas.justeduc <- data.frame((svytable(~just_educ + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
datos.justeduc$just_educ <- factor(datos.justeduc$just_educ, levels = rev(levels(datos.justeduc$just_educ)))
etiquetas.justeduc$just_educ <- factor(etiquetas.justeduc$just_educ, levels = rev(levels(etiquetas.justeduc$just_educ)))
```

```{r alluvial}
colors<- c("#f1eef6ff","#bdc9e1ff","#b3b3b3ff","#74a9cfff","#0570b0ff")
alluvial_justeduc <- ggplot(datos.justeduc, aes(x = ola, fill = just_educ, stratum = just_educ,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(#legend.position = 'top',
          legend.title = element_blank(),
          plot.caption = element_text(hjust = 1)) +
    scale_fill_manual(values = colors) +
    geom_shadowtext(data = etiquetas.justeduc, 
              aes(label = ifelse(porcentaje > 0 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 4,
              color = rep('white'),
              bg.colour='grey30')+
  scale_x_discrete(labels = c(2016, 2017, 2018, 2019, 2022, 2023)) +
  labs(caption = "Source: own elaboration with pooled data from ELSOC 2016-2023 (n = 7576)")

alluvial_justeduc

ggsave(alluvial_justeduc, file="output/graphs/alluvial_dep.png", height = 8, width = 7)
```



```{r bivariate-plots}
df_study1 <- df_study_long_t7_comunas %>% dplyr::select(idencuesta, ola, ponderador_long_total, segmento, estrato,
                                               just_educ, covid_economia, covid_beneficios, merit_talent, merit_effort, des_perc, 
                                               educ, ing_pc, ess, edad, sexo, pos_id) %>% na.omit()
merit_plot <- df_study1 %>% 
  select(merit_effort, merit_talent, des_perc, just_educ) %>% 
  sjPlot::plot_stackfrq(weight.by = df_study1$ponderador_long_total,
                        expand.grid =TRUE,
                      geom.colors = "PuBu",
                      show.total = FALSE, 
                      vjust=rep(c("bottom", "top", "bottom", "top", "bottom"),4),
                      legend.labels = c("Strongly disagree", "Disagree", "Neither agree
nor disagree", "Agree", "Strongly agree"),
                      axis.labels = c("Merit effort", "Merit talent", "Inequality 
perception", "Justification 
of 
educational inequality")
                      ) +
  theme_light(base_size = 16) +
  theme(legend.position="bottom", text = element_text(size = 14),
        plot.caption = element_text(hjust = 1)) +
  labs(caption = "Source: own elaboration with pooled data from ELSOC 2016-2023 (n = 7576)")
merit_plot

ggsave(merit_plot, file="output/graphs/merit_plot.png", height = 6, width = 10)
```


Bivariate descriptive by year

probar ponderadores longitudinales

```{r}
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))
df_study1 <- df_study_long_t7_comunas %>% dplyr::select(idencuesta, ola, ponderador_long_total, segmento, estrato,
                                               just_educ, covid_economia, covid_beneficios, merit_talent, merit_effort, des_perc, 
                                               educ, ing_pc, ess, edad, sexo, pos_id) %>% na.omit()
df_study1 <- df_study1[complete.cases(df_study1$segmento), ]

elsoc_diseno <- as_survey_design(df_study1,
                                 ids = segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ponderador_long_total, #ponderador longitudinal
                          nest = TRUE
                          )

just_years_mean = elsoc_diseno %>% #filter(!is.na(ola)) %>% 
  group_by(ola) %>%
  summarise(education = survey_mean(just_educ, vartype = "ci", na.rm = T)) %>% 
  ungroup()

just_years <- just_years_mean %>% 
  pivot_longer(cols = c("education"), 
               names_to = "variable",
               values_to = "value") %>% 
  cbind(type=c("Dependent")) %>% 
  select(ola, variable, value, type, value_upp=education_upp, value_low=education_low)

ineq_years = elsoc_diseno %>% #filter(!is.na(ola)) %>% 
  group_by(ola) %>%
  summarise(inequality = survey_mean(des_perc, vartype = "ci", na.rm = T),
            ) %>% 
  ungroup()

ineq_years <- ineq_years %>% 
  pivot_longer(cols = c(
                        "inequality"), 
               names_to = "variable",
               values_to = "value") %>% 
  cbind(type=c("Independent")) %>% 
  select(ola, variable, value, type, value_upp=inequality_upp, value_low=inequality_low)

talent_years = elsoc_diseno %>% #filter(!is.na(ola)) %>% 
  group_by(ola) %>%
  summarise(
            talent = survey_mean(merit_talent, vartype = "ci", na.rm = T)) %>% 
  ungroup()

talent_years <- talent_years %>% 
  pivot_longer(cols = c(
                        "talent"), 
               names_to = "variable",
               values_to = "value") %>% 
  cbind(type=c("Independent")) %>% 
  select(ola, variable, value, type, value_upp=talent_upp, value_low=talent_low)

effort_years = elsoc_diseno %>% #filter(!is.na(ola)) %>% 
  group_by(ola) %>%
  summarise(
            effort = survey_mean(merit_effort, vartype = "ci", na.rm = T)) %>% 
  ungroup()

effort_years <- effort_years %>% 
  pivot_longer(cols = c(
                        "effort"), 
               names_to = "variable",
               values_to = "value") %>% 
  cbind(type=c("Independent")) %>% 
  select(ola, variable, value, type, value_upp=effort_upp, value_low=effort_low)
  

vars_years <- rbind(just_years, ineq_years, talent_years, effort_years)


categorias_x <- c(2016, 2017, 2018, 2019, 2022, 2023)
vars_years$variable <- factor(vars_years$variable, levels = c("education", "inequality", "talent", "effort"), labels=  c("Justification
educational
inequality
(dependent)", "Inequality
perception", "Merit: Talent", "Merit: Effort"),
ordered = TRUE)



categorias_z <- c("Justification
educational
inequality
(dependent)", "Inequality
perception
(independent)", "Merit: Talent
(independent)", "Merit: Effort
(independent)")

## Crear el gráfico principal
years_plot <- ggplot(vars_years, aes(ola, value, color = variable, shape = variable, linetype = variable)) +
  theme_bw(base_size = 14) +
  geom_point(size = 4) +
  geom_line(aes(group = variable)) +
  geom_errorbar(aes(ymin = value_low, ymax = value_upp), width = 0.2) +
  ylab("Mean") +
  xlab("Wave") +
  ylim(1, 5) +
  scale_x_discrete(labels = categorias_x) +
  scale_color_manual(labels = categorias_z, name = "Variable", values =  c("#bdc9e1ff","#0570b0ff","#74a9cfff","#b3b3b3ff")) +
  scale_shape_manual(labels = categorias_z, name = "Variable", values = c("square", "circle", "triangle", "diamond")) +
  scale_linetype_manual(labels = categorias_z, name = "Variable", 
                        values = c("solid", "dashed", "dotted", "dotdash")) +  # Definir diferentes tipos de línea
   theme(legend.position = "none") +
  coord_cartesian(xlim = c(1, 7)) +  # Ampliar el eje x
  scale_x_discrete(labels = c(2016, 2017, 2018, 2019, 2022, 2023, ""))  # Personalizar etiquetas del eje x

# Obtener los datos para etiquetar las líneas
label_data <- vars_years %>%
  group_by(variable) %>%
  filter(row_number() == n()) %>%
  ungroup() %>%
  mutate(label_x = 5.5, label_y = value)

# Añadir etiquetas personalizadas
years_plot <- years_plot +
  geom_point(data = label_data, aes(label_x + 1, label_y, color = variable, shape = variable), size = 4) +  # Capa de puntos para los símbolos de forma
  geom_text(data = label_data, aes(label_x, label_y, label = variable), color = "black", hjust = 0, nudge_x = 1.1, nudge_y = 0, size = 4)  +
  labs(caption = "Source: own elaboration with pooled data from ELSOC 2016-2023 (n = 7576)")


years_plot

ggsave("output/graphs/years_plot.png", plot = years_plot, height = 6, width = 7, dpi = 300)
```

## Correlation

```{r cor-plot, fig.dim=c(12,7)}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               sjPlot,
               sjmisc,
               summarytools,
               lavaan
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))
df_study1 <- df_study_long_t7_comunas %>% dplyr::select(idencuesta, ola, ponderador_long_total, segmento, estrato,
                                               just_educ, covid_economia, covid_beneficios, merit_talent, merit_effort, des_perc, 
                                               educ, ing_pc, ess, edad, sexo, pos_id) %>% na.omit()
# Full sample_______________________________________________________________________
mat_full<- 
df_study1 %>%
  # filter(ola==1) %>%
  select(just_educ, # distributive justice
         des_perc,
         merit_effort, merit_talent # meritocracy
         ) %>% 
  psych::mixedCor() 

cor_full <- as.matrix(mat_full$rho)
diag(cor_full) = NA #set diagonal values to NA
# Set Row names of the matrix
rownames(cor_full) <- c("A. Justification of educational inequality",
                        "B. Inequality perception",
                     "C. People are rewarded for their efforts",
                     "D. People are rewarded for their intelligence")
#set Column names of the matrix
colnames(cor_full) <-c("(A)", "(B)","(C)","(D)")
#Plot the matrix using corrplot
png("output/graphs/corr.png",width=700,height=600, pointsize = 10)
corrplot::corrplot(cor_full,
  method = "color", # Cambia los círculos por color completo de cada cuadrante
  addCoef.col = "#000390", # Color de los coeficientes
  type = "upper", # Deja solo las correlaciones de arriba
  tl.col = "black", # COlor letras, rojo por defecto
  na.label = "-")
# Agregar caption
grid::grid.text("Source: own elaboration with pooled data 
from ELSOC 2016-2023 (n = 7576)", x = 0.01, y = 0.05, just = "left", gp = grid::gpar(fontsize = 10, col = "black"))
dev.off()
# mat_1<- 
# df_study1_long_comunas %>%
#   filter(ola==1) %>%
#   select(just_educ, # distributive justice
#          merit_effort, merit_talent, # meritocracy
#          ahead_family, ahead_ambition, ahead_educ, ahead_hardwork # go ahead
#          ) %>% 
#   psych::mixedCor() 
# 
# cor_1 <- as.matrix(mat_1$rho)
# diag(cor_1) = NA #set diagonal values to NA
# # Set Row names of the matrix
# rownames(cor_1) <- c("A. Education distributive justice",
#                      "B. People are rewarded for their efforts",
#                      "C. People are rewarded for their intelligence",
#                      "D. Go ahead: wealthy family",
#                      "E. Go ahead: Having ambition",
#                      "F. Go ahead: Good level of education",
#                      "G. Go ahead: Hard work")
# #set Column names of the matrix
# colnames(cor_1) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)")
# #Plot the matrix using corrplot
# corrplot::corrplot(cor_1,
#   method = "color",
#   addCoef.col = "#000390",
#   type = "upper",
#   tl.col = "black",
#   col=colorRampPalette(c("white","#0068DC"))(12),
#   bg = "white",
#   na.label = "-",
#   title = "\n Wave 1")
# 
# # Wave 2_______________________________________________________________________
# mat_2<-   
# df_study1_long_comunas %>%
#   filter(ola==2) %>% 
#   select(just_educ, # distributive justice
#          merit_effort, merit_talent, # meritocracy
#          ahead_family, ahead_ambition, ahead_educ, ahead_hardwork # go ahead
#          ) %>% 
#   psych::mixedCor() 
# 
# cor_2 <- as.matrix(mat_2$rho)
# diag(cor_2) = NA #set diagonal values to NA
# # Set Row names of the matrix
# rownames(cor_2) <- c("A. Education distributive justice",
#                      "B. People are rewarded for their efforts",
#                      "C. People are rewarded for their intelligence",
#                      "D. Go ahead: wealthy family",
#                      "E. Go ahead: Having ambition",
#                      "F. Go ahead: Good level of education",
#                      "G. Go ahead: Hard work")
# #set Column names of the matrix
# colnames(cor_2) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)")
# #Plot the matrix using corrplot
# corrplot::corrplot(cor_2,
#   method = "color",
#   addCoef.col = "#000390",
#   type = "upper",
#   tl.col = "black",
#   col=colorRampPalette(c("white","#0068DC"))(12),
#   bg = "white",
#   na.label = "-",
#   title = "\n Wave 2")
# 
# 
# # Wave 3_______________________________________________________________________
# mat_3 <- 
# df_study1_long_comunas %>%
#   filter(ola==3) %>% 
#   select(just_educ, # distributive justice
#          merit_effort, merit_talent, # meritocracy
#          ahead_family, ahead_ambition, ahead_educ, ahead_hardwork # go ahead
#          ) %>% 
#   psych::mixedCor()  
# 
# cor_3 <- as.matrix(mat_3$rho)
# diag(cor_3) = NA #set diagonal values to NA
# # Set Row names of the matrix
# rownames(cor_3) <- c("A. Education distributive justice",
#                      "B. People are rewarded for their efforts",
#                      "C. People are rewarded for their intelligence",
#                      "D. Go ahead: wealthy family",
#                      "E. Go ahead: Having ambition",
#                      "F. Go ahead: Good level of education",
#                      "G. Go ahead: Hard work")
# #set Column names of the matrix
# colnames(cor_3) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)")
# #Plot the matrix using corrplot
# corrplot::corrplot(cor_3,
#   method = "color",
#   addCoef.col = "#000390",
#   type = "upper",
#   tl.col = "black",
#   col=colorRampPalette(c("white","#0068DC"))(12),
#   bg = "white",
#   na.label = "-",
#   title = "\n Wave 3")
# 
# # Wave 4_______________________________________________________________________
# mat_4 <- 
# df_study1_long_comunas %>%
#   filter(ola==4) %>% 
#   select(just_educ, # distributive justice
#          merit_effort, merit_talent, # meritocracy
#          ahead_family, ahead_ambition, ahead_educ, ahead_hardwork # go ahead
#          ) %>% 
#   psych::mixedCor() 
# 
# 
# cor_4 <- as.matrix(mat_4$rho)
# diag(cor_4) = NA #set diagonal values to NA
# # Set Row names of the matrix
# rownames(cor_4) <- c("A. Education distributive justice",
#                      "B. People are rewarded for their efforts",
#                      "C. People are rewarded for their intelligence",
#                      "D. Go ahead: wealthy family",
#                      "E. Go ahead: Having ambition",
#                      "F. Go ahead: Good level of education",
#                      "G. Go ahead: Hard work")
# #set Column names of the matrix
# colnames(cor_4) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)")
# #Plot the matrix using corrplot
# corrplot::corrplot(cor_4,
#   method = "color",
#   addCoef.col = "#000390",
#   type = "upper",
#   tl.col = "black",
#   col=colorRampPalette(c("white","#0068DC"))(12),
#   bg = "white",
#   na.label = "-",
#   title = "\n Wave 4")
# 
# 
# # Wave 6_______________________________________________________________________
# mat_6 <- 
# df_study1_long_comunas %>%
#   filter(ola==6) %>% 
#   select(just_educ, # distributive justice
#          merit_effort, merit_talent, # meritocracy
#          ahead_family, ahead_ambition, ahead_educ, ahead_hardwork # go ahead
#          ) %>% 
#   psych::mixedCor() 
# 
# cor_6 <- as.matrix(mat_6$rho)
# diag(cor_6) = NA #set diagonal values to NA
# # Set Row names of the matrix
# rownames(cor_6) <- c("A. Education distributive justice",
#                      "B. People are rewarded for their efforts",
#                      "C. People are rewarded for their intelligence",
#                      "D. Go ahead: wealthy family",
#                      "E. Go ahead: Having ambition",
#                      "F. Go ahead: Good level of education",
#                      "G. Go ahead: Hard work")
# #set Column names of the matrix
# colnames(cor_6) <-c("(A)", "(B)","(C)","(D)","(E)","(F)","(G)")
# #Plot the matrix using corrplot
# corrplot::corrplot(cor_6,
#   method = "color",
#   addCoef.col = "#000390",
#   type = "upper",
#   tl.col = "black",
#   col=colorRampPalette(c("white","#0068DC"))(12),
#   bg = "white",
#   na.label = "-",
#   title = "\n Wave 6")
```

# Models

## A. Justification of educational inequality

```{r distribution-educ, eval=FALSE}
rm(list=ls())
#if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t7_comunas %>%
  select(idencuesta,ola,comuna, ponderador_long_total, just_educ, des_perc, merit_effort, merit_talent, educ, quintil1:sexo) %>% 
  na.omit() %>% 
  mutate(ola=as.factor(ola),
         sexo=as.factor(sexo)
         )
# Hipotesis
h1 <- "ola"
h2 <- "ola+merit_effort+merit_talent"
h3 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo"
h4 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17"
h5 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_univ"
h6 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+univlag22_17"
h7 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_univ+univlag22_17"
h8 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prom_simce_comuna"
h9 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+var_simce_comuna"
h10 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prom_simce_comuna+var_simce_comuna"
h11 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_pagado"
h12 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+pagadolag22_16"
h13 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_pagado+pagadolag22_16"

h13.1 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_pagado+pagadolag22_16+prom_simce_comuna+var_simce_comuna+prop_univ+univlag22_17+gini_ypch+ginilag22_17"



# A. Education distributive justice
educ.null <- lmer(formula(paste0("just_educ~","1 + (1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ1 <- lmer(formula(paste0("just_educ~",h1,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ2 <- lmer(formula(paste0("just_educ~",h2,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ3 <- lmer(formula(paste0("just_educ~",h3,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ4 <- lmer(formula(paste0("just_educ~",h4,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ5 <- lmer(formula(paste0("just_educ~",h5,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ6 <- lmer(formula(paste0("just_educ~",h6,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ7 <- lmer(formula(paste0("just_educ~",h7,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ8 <- lmer(formula(paste0("just_educ~",h8,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ9 <- lmer(formula(paste0("just_educ~",h9,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ10 <- lmer(formula(paste0("just_educ~",h10,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ11 <- lmer(formula(paste0("just_educ~",h11,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ12 <- lmer(formula(paste0("just_educ~",h12,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ13 <- lmer(formula(paste0("just_educ~",h13,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)
educ13.1 <- lmer(formula(paste0("just_educ~",h13.1,"+(1|idencuesta)+(1|comuna)")),data = df_study1, weights = ponderador_long_total)



#omit <- "(pos_id)|(edad)|(cuestion_mig)|(nation_t1)|(quintil1QNA)|(Intercept)"
texreg::knitreg(list(educ1, educ2, educ3, educ4, educ5, educ6, educ7,educ8,educ9,educ10,educ11,educ12,educ13,educ13.1),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
#                custom.coef.names = c("Intercepto",
#                                      "ola 2017 <br> <i>(Ref. ola 2016)</i>",
#                                      "ola 2018",
#                                      "ola 2019",
##                                      "ola 2022",
#                                      "Merito: esfuerzo",
#                                      "Merito: Inteligencia",
##                                      "Goahead: Familia",
#                                      "Goahead: educacion",
#                                      "Goahead: ambicion",
#                                      "Goahead: trabajo duro",
#                                      "Ed. media <br> <i>(Ref. Ed. básica)</i>",
#                                      "Ed. técnica",
#                                      "Ed. universitaria",
#                                      "Quintil 2 <br> <i>(Ref. Quintil 1)</i>",
#                                      "Quintil 3",
#                                      "Quintil 4",
#                                      "Quintil 5",
#                                      "Quintil NA",
#                                      "Estatus social subjetivo",
#                                      "Pos. política: Centro <br> <i>(Ref. izquierda)</i>",
#                                      "Pos. política: Derecha",
#                                      "Pos. política: No se identifica",
#                                      "Edad 30-49 <br> <i>(Ref. 18-29)</i>",
#                                      "Edad 50-64",
#                                      "Edad 65 o más",
#                                      "Mujer <br> <i>(Ref. Hombre)</i>",
#                                      "Gini comunal",
#                                      "Cambio gini 2022-2017",
#                                      "Proporción educ universitaria",
#                                      "Proporción matrícula privada",
#                                      "Total matrícula privada",
#                                      "Varianza Simce comuna",
#                                      "Promedio Simce comuna"
                                    
                              )
          #omit.coef = omit

```

## A2. Education distribution justice (export tables)

```{r eval=FALSE}
#rm(list=ls())
#if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t7_comunas %>%
  select(idencuesta,ola,comuna,just_educ, merit_effort, merit_talent, ahead_family:educ,quintil1:sexo, ginilag22_17, gini_ypch_2022, gini_ypch, prop_univ, gini_gc, prop_pagado, pagadlag22_16=pagadolag22_16, total_mat_pagado, var_simce_comuna_rescaled, prom_simce_comuna_rescaled, univlag22_17, loginc_mean, logincomelag22_17) %>% 
  na.omit() %>% 
  mutate(ola=as.factor(ola),
         sexo=as.factor(sexo)
         )
# Hipotesis
h1 <- "ola"
h2 <- "ola+merit_effort+merit_talent"
h3 <- "ola+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family"
h4 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family"
h5 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo"

h6 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17"
h7 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_univ+univlag22_17"
h8 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17"
h9 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_pagado+pagadlag22_16"
h10 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prom_simce_comuna_rescaled+var_simce_comuna_rescaled"
h11 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled"
h12 <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+loginc_mean+logincomelag22_17"

hfull <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+loginc_mean+logincomelag22_17"



# A. Education distributive justice
educ.null <- lmer(formula(paste0("just_educ~","1 + (1|idencuesta)+(1|comuna)")),data = df_study1)
educ1 <- lmer(formula(paste0("just_educ~",h1,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ2 <- lmer(formula(paste0("just_educ~",h2,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ3 <- lmer(formula(paste0("just_educ~",h3,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ4 <- lmer(formula(paste0("just_educ~",h4,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ5 <- lmer(formula(paste0("just_educ~",h5,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ6 <- lmer(formula(paste0("just_educ~",h6,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ7 <- lmer(formula(paste0("just_educ~",h7,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ8 <- lmer(formula(paste0("just_educ~",h8,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ9 <- lmer(formula(paste0("just_educ~",h9,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ10 <- lmer(formula(paste0("just_educ~",h10,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ11 <- lmer(formula(paste0("just_educ~",h11,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ12 <- lmer(formula(paste0("just_educ~",h12,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ13 <- lmer(formula(paste0("just_educ~",hfull,"+(1|idencuesta)+(1|comuna)")),data = df_study1)

# Table 1: individual

#omit <- "(pos_id)|(edad)|(cuestion_mig)|(nation_t1)|(quintil1QNA)|(Intercept)"
texreg::htmlreg(list(educ1, educ2, educ3, educ4, educ5),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
                custom.coef.names = c("Intercepto",
                                      "ola 2017 <br> <i>(Ref. ola 2016)</i>",
                                      "ola 2018",
                                      "ola 2019",
                                      "ola 2022",
                                      "Merito: esfuerzo",
                                      "Merito: Inteligencia",
                                      "Goahead: trabajo duro",
                                      "Goahead: educacion",
                                      "Goahead: ambicion",
                                      "Goahead: Familia",
                                      "Ed. media <br> <i>(Ref. Ed. básica)</i>",
                                      "Ed. técnica",
                                      "Ed. universitaria",
                                      "Quintil 2 <br> <i>(Ref. Quintil 1)</i>",
                                      "Quintil 3",
                                      "Quintil 4",
                                      "Quintil 5",
                                      "Quintil NA",
                                      "Estatus social subjetivo",
                                      "Pos. política: Centro <br> <i>(Ref. izquierda)</i>",
                                      "Pos. política: Derecha",
                                      "Pos. política: No se identifica",
                                      "Edad 30-49 <br> <i>(Ref. 18-29)</i>",
                                      "Edad 50-64",
                                      "Edad 65 o más",
                                      "Mujer <br> <i>(Ref. Hombre)</i>"),
                file = "output/tables/table1-individuales.html")
          #omit.coef = omit


webshot2::webshot(url ="output/tables/table1-individuales.html" ,file ="output/tables/table1-individuales.png")

```

```{r eval=FALSE}
# table 2: contextuales
omit <- "(ola)|(merit_effort)|(merit_talent)|(ahead_hardwork)|(ahead_educ)|(ahead_ambition)|(ahead_family)|(educ)|(quintil1)|(ess)|(pos_id)|(edad)|(sexo)|(Intercept)"
texreg::htmlreg(list(educ6, educ7,educ8,educ9,educ10,educ11,educ12,educ13),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
                omit.coef = omit,
                custom.coef.names = c(
                                      "Gini comunal",
                                      "Cambio gini 2022-2017",
                                      "Proporción educ universitaria",
                                      "Cambio prop. universitaria 2022-2017",
                                      "Proporción matrícula privada",
                                      "Cambio matrícula privada 2022-2016",
                                      "Promedio Simce comuna",
                                      "Varianza Simce comuna",
                                      "Ingreso comunal",
                                      "Cambio ingreso comunal 2022-2017"),
                file = "output/tables/table2-contextual.html")
          #omit.coef = omit

webshot2::webshot(url ="output/tables/table2-contextual.html" ,file ="output/tables/table2-contextual.png")

```


## Interacciones

```{r distribution-educ-context}
#rm(list=ls())
#if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg,
               ggplot2
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t7_comunas %>%
  select(idencuesta,ola,comuna,just_educ, merit_effort, merit_talent, ahead_family:educ,quintil1:sexo, ginilag22_17, gini_ypch_2022, gini_ypch, prop_univ, gini_gc, prop_pagado, pagadlag22_16=pagadolag22_16, total_mat_pagado, var_simce_comuna_rescaled, prom_simce_comuna_rescaled, univlag22_17, loginc_mean, logincomelag22_17) %>% 
  na.omit() %>% 
  mutate(ola=as.factor(ola),
         sexo=as.factor(sexo)
         )
# Hipotesis
h1b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled"
h2b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+ola*merit_effort"
h3b <- "merit_effort+merit_talent+ola+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+merit_talent*ola"
h4b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+ola*ahead_hardwork"
h5b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+ola*ahead_educ"
h6b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+ola*ahead_ambition"
h7b <- "ola+merit_effort+merit_talent+ahead_hardwork+ahead_educ+ahead_ambition+ahead_family+educ+quintil1+ess+pos_id+edad+sexo+gini_ypch+ginilag22_17+prop_univ+univlag22_17+prop_pagado+pagadlag22_16+prom_simce_comuna_rescaled+var_simce_comuna_rescaled+ola*ahead_family"

# A. Education distributive justice
educ.null <- lmer(formula(paste0("just_educ~","1 + (1|idencuesta)+(1|comuna)")),data = df_study1)
educ1 <- lmer(formula(paste0("just_educ~",h1b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ2 <- lmer(formula(paste0("just_educ~",h2b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ3 <- lmer(formula(paste0("just_educ~",h3b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ4 <- lmer(formula(paste0("just_educ~",h4b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ5 <- lmer(formula(paste0("just_educ~",h5b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ6 <- lmer(formula(paste0("just_educ~",h6b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)
educ7 <- lmer(formula(paste0("just_educ~",h7b,"+(1|idencuesta)+(1|comuna)")),data = df_study1)

# table 3: interacciones
omit <- "(educ)|(quintil1)|(ess)|(pos_id)|(edad)|(sexo)|(Intercept)|(gini_ypch)|(ginilag22_17)|(prop_univ)|(univlag22_17)|(prop_pagado)|(pagadlag22_16)|(prom_simce_comuna_rescaled)|(var_simce_comuna_rescaled)"
texreg::htmlreg(list(educ1, educ2,educ3,educ4,educ5,educ6,educ7),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05",
                custom.coef.names = c("Intercepto",
                                      "2017",
                                      "2018",
                                      "2019",
                                      "2022",
                                      "Merito: esfuerzo",
                                      "Merito: Inteligencia",
                                      "Goahead: trabajo duro",
                                      "Goahead: educacion",
                                      "Goahead: ambicion",
                                      "Goahead: Familia",
                                      "Ed. media <br> <i>(Ref. Ed. básica)</i>",
                                      "Ed. técnica",
                                      "Ed. universitaria",
                                      "Quintil 2 <br> <i>(Ref. Quintil 1)</i>",
                                      "Quintil 3",
                                      "Quintil 4",
                                      "Quintil 5",
                                      "Quintil NA",
                                      "Estatus social subjetivo",
                                      "Pos. política: Centro <br> <i>(Ref. izquierda)</i>",
                                      "Pos. política: Derecha",
                                      "Pos. política: No se identifica",
                                      "Edad 30-49 <br> <i>(Ref. 18-29)</i>",
                                      "Edad 50-64",
                                      "Edad 65 o más",
                                      "Mujer <br> <i>(Ref. Hombre)</i>",
                                      "Gini comunal",
                                      "Cambio gini 2022-2017",
                                      "Proporción educ universitaria",
                                      "Cambio prop. universitaria 2022-2017",
                                      "Proporción matrícula privada",
                                      "Cambio matrícula privada 2022-2016",
                                      "Promedio Simce comuna",
                                      "Varianza Simce comuna",
                                      "2017*merit:esfuerzo",
                                      "2018*merit:esfuerzo",
                                      "2019*merit:esfuerzo",
                                      "2022*merit:esfuerzo",
                                      "2017*merit:talento",
                                      "2018*merit:talento",
                                      "2019*merit:talento",
                                      "2022*merit:talento",
                                      "2017*goahead:hardwork",
                                      "2018*goahead:hardwork",
                                      "2019*goahead:hardwork",
                                      "2022*goahead:hardwork",
                                      "2017*goahead:educ",
                                      "2018*goahead:educ",
                                      "2019*goahead:educ",
                                      "2022*goahead:educ",
                                      "2017*goahead:ambition",
                                      "2018*goahead:ambition",
                                      "2019*goahead:ambition",
                                      "2022*goahead:ambition",
                                      "2017*goahead:family",
                                      "2018*goahead:family",
                                      "2019*goahead:family",
                                      "2022*goahead:family"),
                file = "output/tables/table3-interac.html")
          #omit.coef = omit


webshot2::webshot(url ="output/tables/table3-interac.html" ,file ="output/tables/table3-interac.png")



## graph interact
#sjPlot::plot_model(educ2, type = "int", mdrt.values = "meansd")
predict<-interplot::interplot(m = educ2,var1 = "merit_effort",var2 = "ola",point = T)
predict_data <- predict$data[c(1, 2, 4, 6, 8), ]
predict_data <- predict_data %>% as.data.frame()

predict_data$value <- c("ola1", 
                             "ola2",
                             "ola3", 
                             "ola4",
                             "ola6")
  
predict_data$value <- factor(predict_data$value,
                   levels = c("ola1", 
                             "ola2",
                             "ola3", 
                             "ola4",
                             "ola6"),
                   labels = c("wave 1", 
                              "wave 2",
                              "wave 3",
                              "wave 4",
                              "wave 6"))

interact_effect <- predict_data %>% ggplot(aes(value, coef1)) +
  theme_bw(base_size = 14) +
  geom_point(size = 4)+
  geom_errorbar(aes(ymin=lb, ymax=ub),
                  width=0.2) +
  ylab("Coef") +
  xlab("")
interact_effect

ggsave(interact_effect, file="output/graphs/interact_effect.png", width = 7, height = 7)
```

## Ponderadores

```{r}
#rm(list=ls())
#if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t7_comunas %>%
  select(idencuesta,ola,comuna, ponderador_long_total,just_educ, des_perc, merit_effort, merit_talent, education=educ,quintil1:sexo) %>% 
  na.omit() %>% 
  mutate(ola = as.factor(ola),
         ola_num = as.numeric(ola),
         ola_2=as.numeric(ola)^2,
         sexo=as.factor(sexo)
         )
# Hipotesis
h0 <- "ola"
h1 <- "ola_num+ola_2"
h2 <- "ola_num+ola_2+education+quintil1+ess+edad+sexo"
h3 <- "ola_num+ola_2+education+quintil1+ess+edad+sexo+pos_id"
h4 <- "ola_num+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc"
h5 <- "ola_num+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent"
h6 <- "ola_num+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort"

# A. Education distributive justice
educ.null <- lmer(formula(paste0("just_educ~","1 + (1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ0 <- lmer(formula(paste0("just_educ~",h0,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ1 <- lmer(formula(paste0("just_educ~",h1,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ2 <- lmer(formula(paste0("just_educ~",h2,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ3 <- lmer(formula(paste0("just_educ~",h3,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ4 <- lmer(formula(paste0("just_educ~",h4,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ5 <- lmer(formula(paste0("just_educ~",h5,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ6 <- lmer(formula(paste0("just_educ~",h6,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)

# Table 1: individual

omit <- "(education)|(ess)"
texreg::htmlreg(list(educ0, educ1, educ3, educ4, educ5, educ6),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05. <br>
Note: Model 3 to 6 are controlled by educational level, and subjective social status with no significant effects.", 
                omit.coef = omit,
                custom.coef.names = c("Intercept",
                                      "Wave 2017 <br> <i>(Ref. Wave 2016)</i>",
                                      "Wave 2018",
                                      "Wave 2019",
                                      "Wave 2022",
                                      "Wave 2023",
                                      "Wave",
                                      "Wave^2",
#                                      "High School <br> <i>(Ref. Primary)</i>",
#                                      "Technical",
#                                      "Universitary",
                                      "Quintile 2 <br> <i>(Ref. Quintile 1)</i>",
                                      "Quintile 3",
                                      "Quintile 4",
                                      "Quintile 5",
                                      "Quintile NA",
#                                      "Subjective Social Status",
                                      "Age 30-49 <br> <i>(Ref. 18-29)</i>",
                                      "Age 50-64",
                                      "Age 65 o más",
                                      "Gender <br> <i>(Ref. Male)</i>",
                                      "Pol. pos: Center <br> <i>(Ref. Left)</i>",
                                      "Pol. pos: Right",
                                      "Pol. pos: Does not identify",
                                      "Inequality perception",
                                      "Merit: Talent",
                                      "Merit: Effort" ),
                custom.gof.names = c("AIC",
                                     "BIC",
                                     "Log Likelihood",
                                     "Num. obs.",
                                     "Num. groups: Individuals",
                                     "Var: Individuals (Intercept)",
                                     "Var: Residual"),
                file = "output/tables/table1-individuales-pond-v2.html")
          #omit.coef = omit


webshot2::webshot(url ="output/tables/table1-individuales-pond-v2.html" ,file ="output/tables/table1-individuales-pond-v2.png")

```

## Interacciones

```{r distribution-educ-context}
#rm(list=ls())
#if (!require("pacman")) install.packages("pacman") # instalar pacman
                            # cargar librerias
pacman::p_load(dplyr,       # Manipulacion de datos
               knitr,
               kableExtra,
               summarytools,
               lme4,
               texreg,
               ggplot2
               )
load(file = here::here("input/data-proc/df_study_t6_ind_comunas.RData"))

# generate analytical sample
df_study1 <- 
  df_study_long_t7_comunas %>%
  select(idencuesta,ola,comuna, ponderador_long_total,just_educ, des_perc, merit_effort, merit_talent,education=educ,quintil1:sexo) %>% 
  na.omit() %>% 
  mutate(ola = as.numeric(ola),
         ola_2=as.numeric(ola)^2,
         sexo=as.factor(sexo)
 #        edad=as.numeric(edad)
         #pos_id=as.numeric(pos_id)
         )

# Hipotesis
h1b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+merit_effort*ola"
#h2b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+merit_effort*ola+merit_effort*ola_2"
h6 <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort"


h3b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+merit_talent*ola"
#h4b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+des_perc*ola+des_perc*ola_2"
#h5b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+ola_2*pos_id"
#h6b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+ola_2*sexo"
#h7b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+ola_2*quintil1"
#h8b <- "ola+ola_2+education+quintil1+ess+edad+sexo+pos_id+des_perc+merit_talent+merit_effort+ola_2*edad"

# A. justification educational inequality
educ1 <- lmer(formula(paste0("just_educ~",h1b,"+(ola+merit_effort|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ2 <- lmer(formula(paste0("just_educ~",h2b,"+(ola+ola_2+merit_effort|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ3 <- lmer(formula(paste0("just_educ~",h3b,"+(ola+merit_talent|idencuesta)")),data = df_study1, weights = ponderador_long_total)
educ6 <- lmer(formula(paste0("just_educ~",h6,"+(1|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ4 <- lmer(formula(paste0("just_educ~",h4b,"+(ola+ola_2+des_perc|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ5 <- lmer(formula(paste0("just_educ~",h5b,"+(ola+ola_2|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ6 <- lmer(formula(paste0("just_educ~",h6b,"+(ola+ola_2|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ7 <- lmer(formula(paste0("just_educ~",h7b,"+(ola+ola_2|idencuesta)")),data = df_study1, weights = ponderador_long_total)
#educ8 <- lmer(formula(paste0("just_educ~",h8b,"+(ola+ola_2|idencuesta)")),data = df_study1, weights = ponderador_long_total)

# table 3: interacciones
omit <- "(education)|(ess)|(quintil1)|(edad)|(sexo)|(pos_id)|(des_perc)"
texreg::htmlreg(list(educ6,educ3,educ1),
                custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05. <br>
Note: All the models are controlled by educational level, income quintile, subjective social status, age, gender, <br> political position and inequality perception",
                omit.coef = omit,
                custom.coef.names = c("Intercept",
                                      "Wave",
                                      "Wave^2",
                                      "Merit: Talent",
                                      "Merit: Effort",
                                      "Wave * Merit: Talent",
                                      "Wave * Merit: Effort"
                                      ),
                custom.gof.names = c("AIC", "BIC", "Log Likelihood",
                                     "Num. obs.",
                                     "Num. groups: Individuals",
                                     "Var: Individuals (Intercept)",
                                     "Var: Residual",
                                     "Var: Individuals Wave",
                                     "Var: Individuals Merit: Talent",
                                     "Cov: Individuals (Intercept) Wave",
                                     "Cov: Individuals (Intercept) Merit: Talent",
                                     "Cov: Individuals Wave Merit: Talent",
                                     "Var: Individuals Merit: Effort",
                                     "Cov: Individuals (Intercept) Merit: Effort",
                                     "Cov: Individuals Wave Merit: Effort"),
                file = "output/tables/table3-interac_pond.html")
          #omit.coef = omit

webshot2::webshot(url ="output/tables/table3-interac_pond.html" ,file ="output/tables/table3-interac-pond.png")
```


```{r }
fit <- lmer(just_educ ~ ola + ola_2 + (ola + ola_2 | idencuesta), data = df_study1)

df_study1$pred_inter_pend_aleatorio <- predict(fit)

# Predictions that ignore random effects:
df_study1$fitted <- predict(fit, re.form = ~0)

# Plot just fixed effects:
plot<-df_study1 %>% 
  ggplot(aes(y = fitted, x = ola_2)) +
  geom_line() +
  theme_light()
plot
ggsave(plot, file="output/graphs/fixed_effects.png")


predict<-interplot::interplot(m = educ1,var1 = "ola",point = T)
predict_data <- predict$data[c(1, 2, 4, 6, 7, 8), ]
predict_data <- predict_data %>% as.data.frame()

predict_data$value <- c("ola1", 
                             "ola2",
                             "ola3", 
                             "ola4",
                             "ola6",
                        "ola7")
  
predict_data$value <- factor(predict_data$value,
                   levels = c("ola1", 
                             "ola2",
                             "ola3", 
                             "ola4",
                             "ola6"),
                   labels = c("wave 1", 
                              "wave 2",
                              "wave 3",
                              "wave 4",
                              "wave 6"))

interact_effect <- predict_data %>% ggplot(aes(value, coef1)) +
  theme_bw(base_size = 14) +
  geom_point(size = 4)+
  geom_errorbar(aes(ymin=lb, ymax=ub),
                  width=0.2) +
  ylab("Coef") +
  xlab("")
interact_effect

ggsave(interact_effect, file="output/graphs/interact_effect-pond.png", width = 7, height = 7)
```

